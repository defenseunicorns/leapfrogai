# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: supabase
  version: 0.1.3
  description: >
    supabase instance and all of its dependencies

constants:
  - name: DASHBOARD_USERNAME
    description: The dashboard's (Supabase studio) default username
    value: supabase-admin

variables:
  - name: ENABLE_AUTH
    description: 'Should the auth component be enabled'
    default: "true"
  - name: ENABLE_META
    description: 'Should the meta component be enabled'
    default: "true"
  - name: ENABLE_REALTIME
    description: 'Should the realtime component be enabled'
    default: "true"
  - name: ENABLE_REST
    description: 'Should the rest component be enabled'
    default: "true"  
  - name: ENABLE_STORAGE
    description: 'Should the storage component be enabled'
    default: "true"  
  - name: ENABLE_STUDIO
    description: 'Should the studio component be enabled'
    default: "true"
  - name: ENABLE_VOLUME_PERMISSIONS
    description: 'Should the volume permissions component be enabled'
    default: "true"
  - name: ENABLE_KONG
    description: 'Should the kong component be enabled'
    default: "true"
  - name: ENABLE_POSTGRES
    description: 'Should the postgres component be enabled'
    default: "true"
  - name: EXTERNAL_KEYCLOAK_CLIENT_ID
    description: 'External keycloak client value'
    default: "lfaiui"
  - name: ENABLE_EXTERNAL_KEYCLOAK
    description: 'Should the external keycloak be enabled'
    default: "true"
  - name: EXTERNAL_KEYCLOAK_REDIRECT_URL
    description: 'Keycloaks redirect url'
    default: "https://supabase-kong.uds.dev/auth/v1/callback"
  - name: EXTERNAL_KEYCLOAK_URL
    description: 'External keycloak url'
    default: "https://keycloak.admin.uds.dev/realms/uds"
  - name: EXISTING_POSTGRES_SECRET
    description: 'The name of the existing Postgres secret, if empty the Postgres chart will create a new secret'
    prompt: true
    default: "supabase-postgresql-backup"
  - name: DASHBOARD_PASSWORD
    description: 'The dashboards default password'
    prompt: true
    sensitive: true
    default: "test"
  - name: REGENERATE_DASHBOARD_PASSWORD
    description: 'The dashboards default password'
    prompt: true
    default: "true"

components:
  - name: supabase-jwt-generator
    description: "pre-emptively creates the JWT token ServiceAccount and Job, this prevents hanging from occurring due to the Zarf lifecycle"
    required: true
    charts:
      - name: supabase-bootstrap
        namespace: leapfrogai
        url: oci://registry-1.docker.io/bitnamicharts/supabase
        releaseName: supabase
        version: 4.0.1
        valuesFiles:
          - "bitnami-values-basic.yaml"
    images:
      - docker.io/bitnami/jwt-cli:6.0.0-debian-12-r19
      - docker.io/bitnami/kubectl:1.29.3-debian-12-r4
  - name: supabase-secrets-generator
    description: "pre-emptively creates necessary secrets"
    required: true
    charts:
      - name: supabase-secrets-generator
        namespace: leapfrogai
        localPath: chart/
        releaseName: supabase
        version: 4.0.1
  - name: supabase
    required: true
    charts:
      - name: supabase
        namespace: leapfrogai
        url: oci://registry-1.docker.io/bitnamicharts/supabase
        releaseName: supabase
        version: 4.0.1
        valuesFiles:
          - "bitnami-values.yaml"
    actions:
      onDeploy:
        after:
          - cmd: chmod +x postgres-persistence.sh
          - cmd: ./postgres-persistence.sh
    images:
      - docker.io/bitnami/gotrue:2.149.0-debian-12-r0
      - docker.io/bitnami/jwt-cli:6.0.0-debian-12-r19
      - docker.io/bitnami/kubectl:1.29.3-debian-12-r4
      - docker.io/bitnami/os-shell:12-debian-12-r18
      - docker.io/bitnami/postgrest:11.2.2-debian-12-r14
      - docker.io/bitnami/supabase-postgres:15.1.1-debian-12-r24
      - docker.io/bitnami/supabase-postgres-meta:0.80.0-debian-12-r1
      - docker.io/bitnami/supabase-realtime:2.28.22-debian-12-r0
      - docker.io/bitnami/supabase-storage:0.48.4-debian-12-r0
      - docker.io/bitnami/supabase-studio:0.24.3-debian-12-r0
      - docker.io/bitnami/kong:3.6.1-debian-12-r13
    manifests:
      - name: uds-manifests
        namespace: leapfrogai
        files:
          - "uds-package.yaml"
    files:
      - source: scripts/postgres-persistence.sh
        target: postgres-persistence.sh
        shasum: 69d862bde8e7762ce256e1b4edfe793f11c2df1f9194a52d18b0b943c1272e50
  - name: supabase-post-process
    description: "Perform necessary post processing here"
    required: true
    actions:
      onDeploy:
        before:
          - cmd: kubectl delete cm supabase-kong-declarative-config -n leapfrogai 
        after:
          - cmd: kubectl rollout restart deployment supabase-kong -n leapfrogai
    manifests:
      - name: supabase-manifests
        namespace: leapfrogai
        files:
          - "manifests/declarative-conf-configmap.yaml"